# 基本概念

通信链路: 不同类型的物理媒体(不同的链路能够以不同的速率传输数据)

- 同轴电缆
- 铜线
- 光纤
- 无线电频谱

传输速率: 不同的链路能够以不同的速率传输数据

分组: 当一台端系统要向另外一台端系统发送数据时, 发送端系统将数据分段, 并为每段加上首部字节

分组交换机
作用: 朝着最终目的地转发

- 路由器(通常用于网络核心中)
- 链路层交换机(通常用于接入网中)

路径: 从发送端系统到接收端系统, 一个分组所经历的一系列通信链路和分组交换机成为通过该网络的路径

因特网服务商(Internet Service Provider, ISP)
每个 ISP 自身就是一个由多台分组交换机和多端通信链路组成的网络

协议: 端系统, 分组交换机和其他因特网部件都要运行一系列协议
作用: 控制因特网中信息的接受和发送

TCP(Transmission Control Protocol, 传输控制协议)

IP(Internet Protocol, 网际协议): 定义了在路由器和端系统之间发送和接受的分组格式

因特网标准(Internet Standard)由因特网工程任务组(Internet Engineering Task Force, IETF)研发

IETF 的标准文档称为请求评论(Request For Comment, RFC)

协议(protocol)定义了在两个或多个通信实体之间交换的报文的格式和顺序, 以及报文发送和/或接收一条报文或其他事件所采取的动作

因特网套接字接口(socket interface)是一套发送程序必须遵循的规则集合, 与因特网相连的端系统提供了一个套接字接口, 该接口规定了运行在一个端系统上的程序请求因特网基础设施向运行在另一个端系统上的特定目的地程序交付数据的方式

端系统, 也称为主机(host)

- 客户端(client)
- 服务器(server)

# 因特网概述

## 什么是因特网

1. 构成因特网的基本硬件和软件组件
2. 根据为分布式引用提供服务的联网基础设施来描述因特网

## 网络边缘

端系统位于因特网边缘, 包括桌面计算机, 服务器和移动计算机

接入网: 将端系统物理连接到其边缘路由器(edge router)的网络

1. 家庭接入:
   - 数字用户线(Digital Subscriber Line, DSL),
     - 通常住户从提供本地电话接入的本地电话公司获得 DSL 因特网接入;
     - 因此, 当使用 DSL 时, 用户的本地电话公司也是它的 ISP;
     - 每个用户的 DSL 调制解调器使用现有的电话线与电话公司的本地中心局(CO)中的数字用户线接入复用器(DSLAM)交换数据;
     - 家庭的 DSL 调制解调器得到数字数据后将其转换为高频音, 以通过电话线传输到本地中心局
     - 来自许多家庭的模拟信号在 DSLAM 处被转换回数字形式
   - 电缆
   - FTTH
   - 拨号和卫星
2.

## 网络核心

### 分组交换

1. 存储转发传输
   - 多数分组交换机在链路的输入端使用该机制
   - 指交换机能够开始向输出链路传输该分组的第一个比特之前, 必须接收到整个分组
2. 排队时延和分组丢失
3. 转发表和路由选择协议

### 电路交换

# 应用层

## 原理

### 网络应用程序体系结构

1. C/S 结构
2. P2P 结构

### 进程通信

进行通信的实际上式进程而不是程序

一个进程可以被认为是运行在端系统中的一个程序

不同的端系统上的进程, 通过跨越计算机网络交换报文

1. 客户和服务器进程

2. 进程与计算机网络之间的接口
   进程通过套接字(socket)软件接口向网络发送报文和从网络接收报文

   开发者可以控制套接字在应用层端的一切, 但是对该套接字的运输层端记户没有控制权

   控制仅限于:

   - 选择运输层协议
   - 设定运输层参数, 如最大缓存和最大报文段长度等

3. 进程寻址
   在一台主机上运行的进程为了向在另一台主机上运行的进程发送分组, 接收进程需要有一个地址, 标识地址的信息:

   - 主机的地址
   - 在目的主机中指定接受进程的标识符

目的地端口用于指定接收主机上的接收进程(更具体地说, 接收套接字)

### 可供应用程序使用的运输服务

从以下方面对应用程序服务要求进行分类:

1. 可靠数据传输
   可靠数据传输: 一个协议能够提供了确保由应用程序的一端发送的数据正确, 完全地交付给该应用程序地另一端的数据交付服务

   容忍丢失的应用: 当一个运输层协议不提供可靠数据传输时, 由发送进程发送的某些数据可能到达不了接收进程, 如交谈式音频/视频

2. 吞吐量

   带宽敏感的应用: 具有吞吐量要求的应用程序
   弹性应用: 根据当时可用带宽或多或少利用可供使用的吞吐量

3. 定时

   定时保证能够以多种形式实现

4. 安全性

   运输协议能够为应用程序提供一种或多种安全性服务

### 运输服务的种类

1. `TCP`服务
   `TCP`服务模型

   - 面向连接服务
     - 三次握手
     - 建立一套全双工的连接, 连接双方的进程可以在此连接上同时进行报文发收
     - 四次挥手
   - 可靠数据传输服务
     通信进程能够依靠 TCP, 无差错, 按适当顺序交付所有发送的数据
     当应用程序的一端将字节流传进套接字时, 它能够依靠 TCP 将相同的字节流交付给接收放的套接字, 而没有字节的丢失和冗余

2. `UDP`服务
   一种不提供不必要服务的轻量级运输协议, 仅提供最小服务

   - UDP 是无连接的, 因此在两个进程通信前没有握手过程
   - 提供不可靠数据传送服务, 当进程将一个报文发送进 UDP 套接字时, UDP 协议不保证该报文将到达接收进程, 并且接收进程的报文也可能是乱序的
   - 没有包括拥塞控制机制, 发送端用它选定的任何速率向他的下层(网络层)注入数据(实际端到端吞吐量可能小于该速率, 可能是中间链路的带宽受限或因为拥塞而造成)

3. 因特网运输协议所不提供的服务

### 应用层协议

应用层协议定义了运行在不同端系统上的应用程序进程如何相互传递报文
定义内容:

- 交换的报文类型, 例如请求报文和响应报文
- 各种报文类型的语法, 即这些字段中的信息的含义
- 字段的语义
- 确定一个进程何时机如何发送报文, 对报文进行响应的规则

## Web 和 HTTP

### HTTP 概况

web 的应用层协议是超文本协议(HyperText Transfer Protocol, HTTP)

HTTP 使用 TCP 作为它的支撑运输协议
客户端首先发起一个与服务器的 TCP 连接
一旦连接建立, 浏览器和服务器进程就可以通过套接字进行通信

### 非持续连接和持续连接

非持续连接: 每个请求/响应对是经一个单独的 TCP 连接发送

- 默认方式下, 大部分浏览器打开 5 ~ 10 个并行的 TCP 连接, 而每条连接处理一个请求响应事务

缺点:

- 必须为每一个请求的对象建立和维护一个全新的连接, 客户端和服务端都需要分配 TCP 的缓冲区和保持 TCP 变量
- 每个对象经受两倍 RTT 的交付时延, 一个 RTT 用于创建 TCP, 一个 RTT 用于请求和接收一个对象

持续连接: 所有的请求及其响应经相同的 TCP 请求发送

关闭条件: 一条连接经过一定时间间隔仍未被使用, HTTP 服务关闭该连接
默认模式: 使用带流水线的持续连接

HTTP/2 在 HTTP/1.1 的基础上构建, 允许在相同连接中多个请求和回答交错, 并且增加了在该连接中优化 HTTP 报文请求和回答的机制

### HTTP 报文格式

1. 请求报文

   - 请求行
     - 方法字段
       - GET
       - POST
       - HEAD
       - PUT
       - DELETE
     - URL 字段
     - HTTP 版本字段
   - 首部行
   - 实体体(entity body)

2. 响应报文

   - 状态行
   - 6 个首部行
     - `Connection: close`首部行告诉客户, 发送完报文后将关闭该 `TCP` 连接
     - `Date: `首部行指示服务器产生并发送该响应报文的日期和时间
     - `Server: `首部行指示该报文是由一台 XXX 服务器产生, 类似于 `HTTP` 请求报文中的`User-agent: `首部行
     - `Last-Modified: `首部行指示了对象创建或者最后修改的日期和时间
     - `Content-Length: `首部行指示了被发送对象中的字节数
     - `Content-Type: `首部行指示了实体体中的对象类型
   - 实体体

### Cookie

1. 在`HTTP`响应报文中的一个`cookie`首部行 `Set-cookie: `
2. 在`HTTP`请求报文中的一个`cookie`首部行 `Cookie: `
3. 在用户端系统中保留有一个`cookie`文件, 并由用户的浏览器进行管理
4. 后端数据

### WEB 缓存

Web 缓存器(Web cache)也叫代理服务器(proxy server): 能够代表初始 Web 服务器来满足 HTTP 请求的网络实体

可以配置用户的浏览器使得用户的所有 HTTP 请求首先指向 Web 缓存器

1. 浏览器创建一个到 Web 缓存器的 TCP 连接, 并向 Web 缓存器中的对象发送一个 HTTP 请求
2. Web 缓存器进行检查, 看本地是否存储了该对象副本, 如果有, Web 缓存器就向客户浏览器用 HTTP 响应报文返回该对象
3. 如果 Web 缓存器重没有该对象, 就打开一个与该对象的初始服务器的 TCP 连接

内容分发网络(Content Distribution Network, CDN)
CDN 公司通过在不同地理位置上安装分散的缓存器, 使得大量流量实现了本地化

### 条件 GET 方法

条件 GET 方法(conditional GET)

1. 请求报文使用 GET 方法
2. 请求报文包含一个`If-Modified-Since: `首部行

`If-Modified-Since: `首部行的值正好等于之前服务器发送的响应报文中的`Last-Modified: `首部行的值

状态行中返回为`304 Not Modified`时, 缓存器可以使用该对象, 能向请求的浏览器转发缓存的该对象副本

## 电子邮件

组成部分:

1. 用户代理(user agent)
2. 邮件服务器(mail server)
3. 简单邮件传输(Simple Mail Transfer Protocol, SMTP)

SMTP 和 HTTP 的区别

1. HTTP 主要是一个拉协议(pull protocol)(TCP 连接主要由想要接收文件的机器发起), SMTP 主要是一个推协议(push protocol)(TCP 连接主要由要发送该文件的机器发起的)
2. SMTP 要求每个报文(包括他们的体)采用 7 比特 ASCII 码格式, HTTP 没有这个限制
3. 如何处理一个既包含文本又包含图形的文档, HTTP 把每个对象封装到他自己的 HTTP 响应报文里面, SMTP 把所有报文对象放在一个报文中

邮件报文格式
首部行:

- 每个首部必须含有一个`From: `首部行和一个`To: `首部行
- 一个首部行也许包含一个`Subject: `首部行以及其他可选的首部行

空白行

报文体

- ASCII 格式

邮件访问协议

- 第三版的邮局协议(Post Office Protocol-Version 3, POP3)
  - 端口 110
  - 三个阶段工作
    - 特许(authorization): 用户代理发送(明文形式)用户名和口令以鉴别用户
    - 事务处理: 用户代理取回报文(用户代理还能做: 1. 对报文做标记删除; 2. 取消报文删除标记; 3. 获取邮件的统计信息)
    - 更新: 出现在客户发出了 quit 命令以后, 目的是结束该 POP3 会话
  - 事务处理阶段可能返回
    - +OK(有时后面还跟有服务器到客户的数据)
    - -ERR(被服务器用来指示前面的命令出现了某些差错)
- 因特网邮件访问协议(Internet Mail Access Protocol, IMAP)
- HTTP

## DNS

DNS - 因特网的目录服务

主机的标识方法是用主机名(hostname)

主机也可以用 IP 地址(IP address)进行标识

### DNS 提供的服务

出现的原因: 人类喜欢便于记忆的主机名标识方式, 路由器则喜欢定长且有层次结构的 IP 地址

域名系统(Domain Name System, DNS): 进行主机名到 IP 地址转换的目录服务

1. 一个由分层的 DNS 服务器(DNS server)实现的分布式数据库
2. 一个使得主机能够查询分布式数据库的应用层协议

DNS 服务器通常运行 BIND(Berkeley Internet Name Domain)软件的 UNIX 机器
DNS 协议运行在 UDP 上, 使用 53 号端口

DNS 协议和 HTTP, FTP 和 SMTP 协议一样都是应用层协议

原因:

1. 使用客户 - 服务器模式运行在通信的端系统之间
2. 在通信的端系统之间通过下面的端到端运输协议来传输 DNS 报文

运行过程:

1. 同一台用户主机上运行着 DNS 应用的客户端
2. 浏览器从上述 URL 中抽取出主机名, 并将这台主机名传给 DNS 应用的客户端
3. DNS 客户向 DNS 服务发送一个包含主机名的请求
4. DNS 客户最终会收到一份回答报文, 其中含有对应于该主机名的 IP 地址

重要服务:

- 主机别名(host aliasing), 比主机规范名(canonical hostname)更容易记忆
- 邮件服务器别名(mail server aliasing)
- 负载分配(load distribution), DNS 也用于冗余的服务器之间进行负载分配

### 工作机理概述

DNS 的一种简单设计是在因特网上只使用一个 DNS 服务器, 该服务器包含所有的映射

集中式设计的问题:

- 单点故障(a single point of failure), 如果该 DNS 服务器崩溃, 整个因特网随之瘫痪
- 通信容量(traffic volume), 单个 DNS 服务器不得不处理所有的 DNS 查询
- 远距离的集中式数据库(distant centralized database)
- 维护(maintenance)

分布式设计:

1. 分布式, 层次数据库
   三种类型

   - 根 DNS 服务器 -> 400 多个根名字服务器遍及全球, 由 13 个不同组织管理, 提供 TLD 服务器的 IP 地址
   - 顶级域(Top-Level Domain, TLD)DNS 服务器 -> 对于每个顶级域(如 com, org, net, edu 和 gov)和所有国家的顶级域(如 uk, fr, ca 和 jp)
   - 权威 DNS 服务器

   eg: 查找www.amazon.com

   - 客户首先与根服务器之一联系, 它将返回顶级域名 com 的 TLD 服务器的 IP 地址
   - 该客户与这些 TLD 服务器之一联系, 它将为 amazon.com 返回权威服务器的 IP 地址
   - 最后, 客户与 amazon.com 权威服务器之一联系, 它为主机名www.amazon.com返回其IP地址

   本地 DNS 服务器(local DNS server) 不属于该服务器的层次结构, 但是对于 DNS 层次结构是至关重要
   每个 ISP 都有一台本地 DNS 服务器(也叫做默认名字服务器)

   当主机与某个 ISP 连接时, 该 ISP 提供一台主机的 IP 地址, 该主机剧有一台或多台其本地 DNS 服务器的 IP 地址(通常通过 DHCP)

   当主机发送 DNS 请求时, 该请求被发送至本地 DNS 服务器, 起着代理的作用, 并将请求发送到 DNS 服务器层次结构中

   查询 DNS 服务器

   1. 递归查询
      - 本地 DNS 服务器一对一
   2. 迭代查询
      - 本地 DNS 服务器一对多
      - 可以理解为已知根服务器, TLD DNS 服务器, 权威服务器等 IP, 不需要根服务器去找 TLD DNS 服务器

2. DNS 缓存
   在一个请求链中, 当某 DNS 服务器接收一个 DNS 回答时, 将映射缓存在本地存储器
   主机和主机名与 IP 地址间的映射并不是永久的, DNS 服务器在一段时间后(通常设置为两天)将丢弃缓存的信息

   本地 DNS 服务器能够缓存 TLD 服务器的 IP 地址, 因而允许本地 DNS 绕过查询链中的根 DNS 服务器

### DNS 记录和报文

资源记录(Resource Record, RR), RR 提供了主机名到 IP 地址的映射
每个 DNS 回答报文包含了一条或多条资源记录, 资源记录是一个 4 元组: (Name, Value, Type, TTL)
TTL 是该记录的生存时间, 决定了资源记录应当从缓存中删除的时间,

- Type = A -> Name 是主机名, Value 是该主机名对应的 IP 地址
- Type = NS -> Name 是个域, Value 是个知道如何获得该域中主机 IP 地址的权威 DNS 服务器的主机名
- Type = CNAME -> Value 是别名为 Name 的主机对应的规范主机名
- Type = MX -> Value 是个别名为 Name 的邮件服务器的规范主机名

1. DNS 报文
   DNS 查询和回答报文

   - 前 12 个字节是首部区域
     - 标识符 -> 16 比特的数, 用于标识该查询
     - 1 比特的查询/回答标志位 -> 指出是查询报文(0)还是回答报文(1)
     - 1 比特的权威的标志位
     - 1 比特的希望递归标志位
     - 1 比特的递归可用标志位
     - 1 比特的递归可用标志位
     - 4 个有关数量的字段
   - 问题区域包含着正在进行的查询信息
     - 名字字段, 包含正在被查询的主机名字
     - 类型字段, 指出有关该名字的正被询问的问题类型
   - 在来自 DNS 服务器的回答中, 回答区域包含了对最初请求的名字的资源记录
   - 权威区域包含其他权威服务器的记录
   - 附加区域包含了其他有帮助的记录

2. 在 DNS 数据库中插入记录
   注册登记机构(registrar)是一个商业实体, 验证该域名的唯一性

DNS 脆弱性

分布式拒绝服务(DDoS)带宽洪泛攻击
中间人攻击

## P2P文件分发


## 视频流和内容分发网

